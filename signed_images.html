

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>从可信的来源更新镜像 &mdash; Embedded Software Update Documentation 2018.11 文档</title>
  

  
  
    <link rel="shortcut icon" href="_static/SWUpdate.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="对称加密更新镜像" href="encrypted_images.html" />
    <link rel="prev" title="SWUpdate:使用默认解析器的语法和标记" href="sw-description.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Embedded Software Update Documentation
          

          
          </a>

          
            
            
              <div class="version">
                2018.11
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">嵌入式系统的软件管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="licensing.html">许可证</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="swupdate.html">SWUpdate: 嵌入式系统的软件升级</a></li>
<li class="toctree-l1"><a class="reference internal" href="sw-description.html">SWUpdate:使用默认解析器的语法和标记</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">从可信的来源更新镜像</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">对复合镜像进行签名</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">对子镜像进行签名</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sw-description">对sw-description进行签名并与哈希验证相结合</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">算法的选择</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">生成密钥/证书的工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rsa-pkcs-1-5">使用 RSA PKCS#1.5</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">生成私钥和公钥</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rsa">如何使用RSA进行签名</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cms">与证书和CMS一起使用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">生成自签名证书</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pki">使用PKI颁发的证书</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">如何用CMS签名</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#swu">构建签名的SWU镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">签名镜像的sw-description示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#swupdate">对签名镜像运行SWUpdate</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="encrypted_images.html">对称加密更新镜像</a></li>
<li class="toctree-l1"><a class="reference internal" href="handlers.html">处理程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongoose.html">Mongoose 守护进程模式</a></li>
<li class="toctree-l1"><a class="reference internal" href="suricatta.html">Suricatta 守护进程模式</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-ipc.html">SWUpdate:用于外部程序的API</a></li>
<li class="toctree-l1"><a class="reference internal" href="progress.html">在运行更新时获取信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="building-with-yocto.html">meta-swupdate: 使用Yocto进行编译</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="help_and_support.html">帮助和支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为SWUpdate做贡献</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">项目规划</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Embedded Software Update Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>从可信的来源更新镜像</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/signed_images.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>从可信的来源更新镜像<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>现在越来越重要的是，设备不仅要能安全地进行更新操作，
而且要能够验证发送的图像是否来自一个已知的源，
并且没有嵌入恶意软件。</p>
<p>为了实现这个目标，SWUpdate必须验证传入的镜像。
有几种方法可以做到这一点。
这里有一些问题，完整的复合镜像需要签名吗?还是只是它的某些部分需要?</p>
<p>不同做法的优缺点将在下一章中描述。</p>
<div class="section" id="id2">
<h2>对复合镜像进行签名<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>一个直接了当的做法是对整个复合镜像进行签名。但是。这样做有一些严重
的缺点。这会导致无法在加载完整个复合镜像之前对镜像进行验证。
这意味着，校验需要在安装了镜像之后才进行，而不是在实际写入设备
之前就能进行。
这会导致，如果校验失败，需要对已经安装好的镜像做一些取消安装的操作，
这种取消安装的操作，在碰到掉电时，可能会导致一些不希望保留的数据被保留在设备上。</p>
</div>
<div class="section" id="id3">
<h2>对子镜像进行签名<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>如果每个子图像都签名了，验证就可以在操作相应的硬件之前完成。
只有签名正确的镜像会被实际安装。
不过这样存在一个问题，子镜像没有跟sw-descrription文件中的发布描述绑定到一起。
即使sw-description也做了签名，即使对sw-description进行了签名，攻击者也可以
将签名子镜像们混合在一起，生成可以安装的新的复合镜像，因为所有子镜像都可通过验证。</p>
</div>
<div class="section" id="sw-description">
<h2>对sw-description进行签名并与哈希验证相结合<a class="headerlink" href="#sw-description" title="永久链接至标题">¶</a></h2>
<p>为了避免所描述的缺点，SWUpdate将签名的sw-description与每个子镜像的哈希验证结合起来。
这意味着只有经过验证的源代码生成的sw-description才能被安装程序接受。
而sw-description包含每个子镜像的哈希值，可验证每个交付的子镜像确实属于本次发布。</p>
</div>
<div class="section" id="id4">
<h2>算法的选择<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>可以通过menuconfig选择签名和验证sw-descrription文件的算法。
目前，实现了以下机制:</p>
<ul class="simple">
<li>RSA 公钥/私钥。 私钥属于编译系统，而公钥需要被安装到设备上。</li>
<li>使用证书的CMS</li>
</ul>
<p>密钥或证书使用”-k”参数传递给SWUpdate。</p>
</div>
<div class="section" id="id5">
<h2>生成密钥/证书的工具<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p><cite>openssl</cite> 工具用于生成密钥。这是OpenSSL项目的一部分。完整的文档可以
在 <a class="reference external" href="https://www.openssl.org/docs/manmaster/man1/openssl.html">openSSL 网站</a> 上找到</p>
</div>
<div class="section" id="rsa-pkcs-1-5">
<h2>使用 RSA PKCS#1.5<a class="headerlink" href="#rsa-pkcs-1-5" title="永久链接至标题">¶</a></h2>
<div class="section" id="id6">
<h3>生成私钥和公钥<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>首先，需要生成私钥</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">genrsa</span> <span class="o">-</span><span class="n">aes256</span> <span class="o">-</span><span class="n">out</span> <span class="n">priv</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>这里需要一个密码。可以从文件中去获取这个密码 - 当然，
这个密码文件必须保护好，防止被入侵。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">genrsa</span> <span class="o">-</span><span class="n">aes256</span> <span class="o">-</span><span class="n">passout</span> <span class="n">file</span><span class="p">:</span><span class="n">passout</span> <span class="o">-</span><span class="n">out</span> <span class="n">priv</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>使用如下命令，从私钥导出公钥:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">rsa</span> <span class="o">-</span><span class="ow">in</span> <span class="n">priv</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">out</span> <span class="n">public</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">outform</span> <span class="n">PEM</span> <span class="o">-</span><span class="n">pubout</span>
</pre></div>
</div>
<p>“public.pem” 包含了适用于swupdate的格式的密钥。
该文件可以通过-k参数在命令行传递给swupdate。</p>
</div>
<div class="section" id="rsa">
<h3>如何使用RSA进行签名<a class="headerlink" href="#rsa" title="永久链接至标题">¶</a></h3>
<p>对镜像进行签名非常简单:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">dgst</span> <span class="o">-</span><span class="n">sha256</span> <span class="o">-</span><span class="n">sign</span> <span class="n">priv</span><span class="o">.</span><span class="n">pem</span> <span class="n">sw</span><span class="o">-</span><span class="n">description</span> <span class="o">&gt;</span> <span class="n">sw</span><span class="o">-</span><span class="n">description</span><span class="o">.</span><span class="n">sig</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cms">
<h2>与证书和CMS一起使用<a class="headerlink" href="#cms" title="永久链接至标题">¶</a></h2>
<div class="section" id="id7">
<h3>生成自签名证书<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">req</span> <span class="o">-</span><span class="n">x509</span> <span class="o">-</span><span class="n">newkey</span> <span class="n">rsa</span><span class="p">:</span><span class="mi">4096</span> <span class="o">-</span><span class="n">nodes</span> <span class="o">-</span><span class="n">keyout</span> <span class="n">mycert</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">pem</span> \
    <span class="o">-</span><span class="n">out</span> <span class="n">mycert</span><span class="o">.</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">subj</span> <span class="s2">&quot;/O=SWUpdate /CN=target&quot;</span>
</pre></div>
</div>
<p>有关参数的更多信息，请参阅文档。
“mycert.key.pem” 包含了私钥，用于签名。
它 <em>不能</em> 被部署到目标设备上。</p>
<p>目标设备上必须安装有 “mycert.cert.pem” - 这将被SWUpdate用于完成校验。</p>
</div>
<div class="section" id="pki">
<h3>使用PKI颁发的证书<a class="headerlink" href="#pki" title="永久链接至标题">¶</a></h3>
<p>也可以使用PKI签发的代码签名证书。
不过，SWUpdate是使用OpenSSL库来处理CMS签名的，该库要求在签名证书上设置以下属性:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">keyUsage</span><span class="o">=</span><span class="n">digitalSignature</span>
<span class="n">extendedKeyUsage</span><span class="o">=</span><span class="n">emailProtection</span>
</pre></div>
</div>
<p>如果不能满足此要求，也可以完全禁用签名证书密钥检查。
这是由 <cite>CONFIG_CMS_IGNORE_CERTIFICATE_PURPOSE</cite> 配置选项控制的。</p>
</div>
<div class="section" id="id8">
<h3>如何用CMS签名<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>对镜像进行签名，跟前一种情况一样很简单:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">cms</span> <span class="o">-</span><span class="n">sign</span> <span class="o">-</span><span class="ow">in</span>  <span class="n">sw</span><span class="o">-</span><span class="n">description</span> <span class="o">-</span><span class="n">out</span> <span class="n">sw</span><span class="o">-</span><span class="n">description</span><span class="o">.</span><span class="n">sig</span> <span class="o">-</span><span class="n">signer</span> <span class="n">mycert</span><span class="o">.</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span> \
        <span class="o">-</span><span class="n">inkey</span> <span class="n">mycert</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">outform</span> <span class="n">DER</span> <span class="o">-</span><span class="n">nosmimecap</span> <span class="o">-</span><span class="n">binary</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="swu">
<h2>构建签名的SWU镜像<a class="headerlink" href="#swu" title="永久链接至标题">¶</a></h2>
<p>有两个文件，sw-description和它的签名sw-description.sig。
签名文件必须紧跟在描述文件后面。</p>
<p>sw-description中的每个图像必须具有 “sha256” 属性，
即镜像的sha256校验和。如果有一个镜像不具有sha256属性，
则整个复合镜像的的校验结果会是未通过，SWUpdate在开始安装之前会停止并报错。</p>
<p>创建签名镜像的简单脚本可以是:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

MODE=&quot;RSA&quot;
PRODUCT_NAME=&quot;myproduct&quot;
CONTAINER_VER=&quot;1.0&quot;
IMAGES=&quot;rootfs kernel&quot;
FILES=&quot;sw-description sw-description.sig $IMAGES&quot;

#if you use RSA
if [ x&quot;$MODE&quot; == &quot;xRSA&quot; ]; then
    openssl dgst -sha256 -sign priv.pem sw-description &gt; sw-description.sig
else
    openssl cms -sign -in  sw-description -out sw-description.sig -signer mycert.cert.pem \
        -inkey mycert.key.pem -outform DER -nosmimecap -binary
fi
for i in $FILES;do
        echo $i;done | cpio -ov -H crc &gt;  ${PRODUCT_NAME}_${CONTAINER_VER}.swu
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2>签名镜像的sw-description示例<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<p>本例应用于Beaglebone，安装Yocto images:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">software</span> <span class="o">=</span>
<span class="p">{</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">;</span>

        <span class="n">hardware</span><span class="o">-</span><span class="n">compatibility</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;revC&quot;</span><span class="p">];</span>

        <span class="n">images</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;core-image-full-cmdline-beaglebone.ext3&quot;</span><span class="p">;</span>
                    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/mmcblk0p2&quot;</span><span class="p">;</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span><span class="p">;</span>
                    <span class="n">sha256</span> <span class="o">=</span> <span class="s2">&quot;43cdedde429d1ee379a7d91e3e7c4b0b9ff952543a91a55bb2221e5c72cb342b&quot;</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">);</span>
        <span class="n">scripts</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;test.lua&quot;</span><span class="p">;</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;lua&quot;</span><span class="p">;</span>
                    <span class="n">sha256</span> <span class="o">=</span> <span class="s2">&quot;f53e0b271af4c2896f56a6adffa79a1ffa3e373c9ac96e00c4cfc577b9bea5f1&quot;</span><span class="p">;</span>
                 <span class="p">}</span>
        <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="swupdate">
<h2>对签名镜像运行SWUpdate<a class="headerlink" href="#swupdate" title="永久链接至标题">¶</a></h2>
<p>验证是通过在SWUpdate的配置中设置CONFIG_SIGNED_IMAGES激活的。
一旦激活，SWUpdate将始终检查复合图像。
出于安全原因，不可能在运行时禁用检查。
-k参数(公钥文件)是必须的，如果公钥没有传递，程序将终止运行。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="encrypted_images.html" class="btn btn-neutral float-right" title="对称加密更新镜像" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sw-description.html" class="btn btn-neutral" title="SWUpdate:使用默认解析器的语法和标记" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2018, Stefano Babic

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>